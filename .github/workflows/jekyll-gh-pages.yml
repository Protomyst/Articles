name: Deploy Jekyll with GitHub Pages

on:
  # åœ¨æ·»åŠ å‰ç½®æ•°æ®çš„å·¥ä½œæµå®Œæˆåè§¦å‘
  workflow_run:
    workflows: ["Add YAML Front Matter"]
    types:
      - completed
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # åœ¨æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: ["main"]

# è®¾ç½® GITHUB_TOKEN çš„æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# å…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Create Jekyll Configuration
        run: |
          # åˆ›å»º Gemfile
          cat > Gemfile <<EOL
          source 'https://rubygems.org'
          gem 'jekyll'
          gem 'jekyll-theme-minimal'
          gem 'webrick'
          EOL
          
          # åˆ›å»º _config.yml
          cat > _config.yml <<EOL
          title: Articles
          description: Collected Articles
          theme: jekyll-theme-minimal
          author: Protomyst
          baseurl: "/Articles"
          url: "https://protomyst.github.io"
          
          # æ·»åŠ æ’ä»¶æ”¯æŒ
          plugins:
            - jekyll-theme-minimal
          
          # æ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶
          exclude:
            - Gemfile
            - Gemfile.lock
            - node_modules
            - vendor/bundle/
            - vendor/cache/
            - vendor/gems/
            - vendor/ruby/
            - .github/
          EOL
          
          # åˆ›å»ºå¸ƒå±€ç›®å½•å’Œæ–‡ä»¶
          mkdir -p _layouts
          
          # åˆ›å»ºæ–‡ç« å¸ƒå±€
          cat > _layouts/post.html <<EOL
          ---
          layout: default
          ---
          <h1>{{ page.title }}</h1>
          <p class="meta">å‘å¸ƒæ—¥æœŸ: {{ page.date | date: "%Y-%m-%d" }}</p>
          {% if page.path %}
          <p class="path">æ–‡ä»¶è·¯å¾„: {{ page.path }}</p>
          {% endif %}
          <div class="post-content">
            {{ content }}
          </div>
          EOL
          
          # åˆ›å»ºä¸»é¡µ
          cat > index.md <<EOL
          ---
          layout: default
          title: Articles | Collected Articles
          ---
          
          # æ–‡ç« åˆ—è¡¨
          
          {% assign sorted_pages = site.pages | sort: "date" | reverse %}
          {% for page in sorted_pages %}
            {% if page.layout == 'post' %}
          * {{ page.date | date: "%Y-%m-%d" }} - [{{ page.title }}]({{ page.url | relative_url }})
            <br><small>ğŸ“ {{ page.path }}</small>
            {% endif %}
          {% endfor %}
          
          ## æ–‡ä»¶å¤¹ç»“æ„
          
          {% assign folders = site.pages | map: "path" | map: "dirname" | uniq | sort %}
          {% for folder in folders %}
            {% unless folder == "" or folder == "." or folder contains "layouts" %}
          ### ğŸ“ {{ folder }}
            {% assign folder_pages = site.pages | where_exp: "item", "item.path contains folder" %}
            {% for page in folder_pages %}
              {% if page.layout == 'post' %}
          * {{ page.date | date: "%Y-%m-%d" }} - [{{ page.title }}]({{ page.url | relative_url }})
              {% endif %}
            {% endfor %}
            {% endunless %}
          {% endfor %}
          EOL

      - name: Install Dependencies
        run: |
          bundle install

      - name: Build with Jekyll
        run: |
          bundle exec jekyll build
        env:
          JEKYLL_ENV: production

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
