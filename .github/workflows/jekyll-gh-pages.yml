name: Deploy Jekyll with GitHub Pages

on:
  # 在添加前置数据的工作流完成后触发
  workflow_run:
    workflows: ["Add YAML Front Matter"]
    types:
      - completed
  # 允许手动触发
  workflow_dispatch:
  # 在推送到主分支时触发
  push:
    branches: ["main"]

# 设置 GITHUB_TOKEN 的权限
permissions:
  contents: read
  pages: write
  id-token: write

# 允许一个并发部署
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Create Jekyll Configuration
        run: |
          # 创建 Gemfile
          cat > Gemfile <<EOL
          source 'https://rubygems.org'
          gem 'jekyll'
          gem 'jekyll-theme-minimal'
          gem 'webrick'
          EOL
          
          # 创建 _config.yml
          cat > _config.yml <<EOL
          title: Articles
          description: Collected Articles
          theme: jekyll-theme-minimal
          author: Protomyst
          baseurl: "/Articles"
          url: "https://protomyst.github.io"
          
          # 添加插件支持
          plugins:
            - jekyll-theme-minimal
          
          # 排除不需要的文件
          exclude:
            - Gemfile
            - Gemfile.lock
            - node_modules
            - vendor/bundle/
            - vendor/cache/
            - vendor/gems/
            - vendor/ruby/
            - .github/
          EOL
          
          # 创建布局目录和文件
          mkdir -p _layouts
          
          # 创建文章布局
          cat > _layouts/post.html <<EOL
          ---
          layout: default
          ---
          <h1>{{ page.title }}</h1>
          <p class="meta">发布日期: {{ page.date | date: "%Y-%m-%d" }}</p>
          {% if page.path %}
          <p class="path">文件路径: {{ page.path }}</p>
          {% endif %}
          <div class="post-content">
            {{ content }}
          </div>
          EOL
          
          # 创建主页
          cat > index.md <<EOL
          ---
          layout: default
          title: Articles | Collected Articles
          ---
          
          # 文章列表
          
          {% assign sorted_pages = site.pages | sort: "date" | reverse %}
          {% for page in sorted_pages %}
            {% if page.layout == 'post' %}
          * {{ page.date | date: "%Y-%m-%d" }} - [{{ page.title }}]({{ page.url | relative_url }})
            <br><small>📁 {{ page.path }}</small>
            {% endif %}
          {% endfor %}
          
          ## 文件夹结构
          
          {% assign folders = site.pages | map: "path" | map: "dirname" | uniq | sort %}
          {% for folder in folders %}
            {% unless folder == "" or folder == "." or folder contains "layouts" %}
          ### 📁 {{ folder }}
            {% assign folder_pages = site.pages | where_exp: "item", "item.path contains folder" %}
            {% for page in folder_pages %}
              {% if page.layout == 'post' %}
          * {{ page.date | date: "%Y-%m-%d" }} - [{{ page.title }}]({{ page.url | relative_url }})
              {% endif %}
            {% endfor %}
            {% endunless %}
          {% endfor %}
          EOL

      - name: Install Dependencies
        run: |
          bundle install

      - name: Build with Jekyll
        run: |
          bundle exec jekyll build
        env:
          JEKYLL_ENV: production

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
