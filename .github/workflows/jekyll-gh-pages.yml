name: Deploy Jekyll with GitHub Pages

on:
  # 在添加前置数据的工作流完成后触发
  workflow_run:
    workflows: ["Add YAML Front Matter"]
    types:
      - completed
  # 允许手动触发
  workflow_dispatch:
  # 在推送到主分支时触发
  push:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true
      - name: Setup Pages
        uses: actions/configure-pages@v4
      - name: Create Jekyll site
        run: |
          # 创建配置文件
          cat > _config.yml <<EOL
          title: Articles
          description: Collected Articles
          theme: jekyll-theme-minimal
          author: Protomyst
          permalink: /:categories/:title.html
          timezone: UTC
          future: true
          EOL
          
          # 创建布局目录和文件
          mkdir -p _layouts
          
          # 创建默认布局
          cat > _layouts/default.html <<EOL
          <!DOCTYPE html>
          <html lang="zh">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>{{ page.title }} - {{ site.title }}</title>
            <style>
              body { max-width: 800px; margin: 0 auto; padding: 20px; font-family: -apple-system, system-ui, sans-serif; line-height: 1.6; }
              .header { border-bottom: 1px solid #eee; margin-bottom: 20px; }
              .meta { color: #666; font-size: 0.9em; }
              .path { color: #666; font-size: 0.9em; margin-bottom: 20px; }
              .folder-icon { color: #0366d6; }
              .article-list { list-style-type: none; padding: 0; }
              .article-item { margin-bottom: 10px; }
              .article-date { color: #666; font-size: 0.9em; }
              .folder-section { margin: 20px 0; }
              .nav { margin-bottom: 20px; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1><a href="{{ '/' | relative_url }}" style="text-decoration: none; color: inherit;">{{ site.title }}</a></h1>
              <p>{{ site.description }}</p>
            </div>
            {{ content }}
          </body>
          </html>
          EOL
          
          # 创建文章布局
          cat > _layouts/post.html <<EOL
          ---
          layout: default
          ---
          <div class="nav">
            <a href="{{ '/' | relative_url }}">← 返回首页</a>
          </div>
          <article>
            <h1>{{ page.title }}</h1>
            <p class="meta">发布于 {{ page.date | date: "%Y-%m-%d" }} by {{ page.author }}</p>
            {% if page.category %}
            <p class="path">分类: {{ page.category }}</p>
            {% endif %}
            <div class="content">
              {{ content }}
            </div>
          </article>
          EOL
          
          # 创建主页
          cat > index.md <<EOL
          ---
          layout: default
          title: 文章列表
          ---
          
          ## 最近更新
          
          <ul class="article-list">
          {% assign sorted_pages = site.pages | where: "layout", "post" | sort: "date" | reverse %}
          {% for page in sorted_pages limit:5 %}
            <li class="article-item">
              <span class="article-date">{{ page.date | date: "%Y-%m-%d" }}</span>
              <br>
              <a href="{{ page.url | relative_url }}">{{ page.title }}</a>
              {% if page.category %}
              <br>
              <small>📁 {{ page.category }}</small>
              {% endif %}
            </li>
          {% endfor %}
          </ul>
          
          ## 文件夹结构
          
          {% assign folders = site.pages | map: "category" | uniq | sort %}
          {% for folder in folders %}
            {% unless folder == "" or folder == nil %}
          <div class="folder-section">
            <h3><span class="folder-icon">📁</span> {{ folder }}</h3>
            <ul class="article-list">
              {% assign folder_pages = site.pages | where: "category", folder | sort: "date" | reverse %}
              {% for page in folder_pages %}
                {% if page.layout == "post" %}
                <li class="article-item">
                  <span class="article-date">{{ page.date | date: "%Y-%m-%d" }}</span>
                  <br>
                  <a href="{{ page.url | relative_url }}">{{ page.title }}</a>
                </li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>
            {% endunless %}
          {% endfor %}
          
          ## 未分类文章
          
          <ul class="article-list">
          {% assign uncategorized_pages = site.pages | where: "layout", "post" | where: "category", nil | sort: "date" | reverse %}
          {% for page in uncategorized_pages %}
            <li class="article-item">
              <span class="article-date">{{ page.date | date: "%Y-%m-%d" }}</span>
              <br>
              <a href="{{ page.url | relative_url }}">{{ page.title }}</a>
            </li>
          {% endfor %}
          </ul>
          EOL

      - name: Build with Jekyll
        run: |
          bundle init
          bundle add jekyll
          bundle exec jekyll build
        env:
          JEKYLL_ENV: production
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
